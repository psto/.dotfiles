#!/usr/bin/env sh

time_input=$(rofi -config ~/.config/rofi/searchmenu.rasi -dmenu -p 'Minutes')

# Replace comma with a dot for consistent decimal handling
time_normalized=$(echo "$time_input" | sed 's/,/./g')

# Exit if the time is empty or not a valid number
if ! echo "$time_normalized" | grep -Eq '^[0-9]+(\.[0-9]+)?$' || [ -z "$time_normalized" ]; then
    exit 1
fi

# Convert minutes to seconds for the sleep command
time_seconds=$(echo "$time_normalized * 60" | bc)

message=$(rofi -config ~/.config/rofi/searchmenu.rasi -dmenu -p 'Message')

if [ -z "$message" ]; then
    exit 2
fi

# Sleep for the calculated duration and send the notification
sleep "$time_seconds" && notify-send "Timer done" "$message"

# Play the sound file in the background and get its process ID
mpv --loop-file ~/public/music/ubuntu_add.mp3 &
pid=$!

# Loop until the user presses any key
while true; do
    # Prompt the user to stop the sound using rofi.
    stop=$(rofi -config ~/.config/rofi/searchmenu.rasi -dmenu -p "TIMER FOR: $message")

    # Exit if the user pressed Enter (empty string) or typed something
    if [ -n "$stop" ] || [ -z "$stop" ]; then
        break
    fi
done

# Kill the mpv process
kill $pid
